<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        <link rel="canonical" href="http://docs.openindiana.org/dev/repo-cleanup/">
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>Cleaning up OpenIndiana repository - OpenIndiana Docs</title>
        <link href="../../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/color-brewer.min.css">
        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->

        <script src="../../js/jquery-1.10.2.min.js" defer></script>
        <script src="../../js/bootstrap-3.0.3.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script>
        <script>
            (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
            })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

            ga('create', 'UA-77447740-2', 'auto');
            ga('send', 'pageview');
        </script> 
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
            <div class="container">

                <!-- Collapsed navigation -->
                <div class="navbar-header">
                    <!-- Expander button -->
                    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="../..">OpenIndiana Docs</a>
                </div>

                <!-- Expanded navigation -->
                <div class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li >
                                <a href="../..">Home</a>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">About <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../../misc/openindiana/">About OpenIndiana</a>
</li>
                                    
<li >
    <a href="../../misc/oi-docs/">About OpenIndiana Docs</a>
</li>
                                    
<li >
    <a href="../../misc/conduct/">OpenIndiana Code of Conduct</a>
</li>
                                    
<li >
    <a href="../../misc/pdl/">Public Documentation License</a>
</li>
                                    
  <li class="dropdown-submenu">
    <a href="#">Release Notes</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../release-notes/latest-changes/">Latest changes</a>
</li>
            
<li >
    <a href="../../release-notes/2020.10-release-notes/">2020.10 Release Notes</a>
</li>
            
<li >
    <a href="../../release-notes/2020.04-release-notes/">2020.04 Release Notes</a>
</li>
            
<li >
    <a href="../../release-notes/2019.10-release-notes/">2019.10 Release Notes</a>
</li>
            
<li >
    <a href="../../release-notes/2019.04-release-notes/">2019.04 Release Notes</a>
</li>
            
<li >
    <a href="../../release-notes/2018.10-release-notes/">2018.10 Release Notes</a>
</li>
            
<li >
    <a href="../../release-notes/2018.04-release-notes/">2018.04 Release Notes</a>
</li>
            
<li >
    <a href="../../release-notes/2017.10-release-notes/">2017.10 Release Notes</a>
</li>
            
<li >
    <a href="../../release-notes/2017.04-release-notes/">2017.04 Release Notes</a>
</li>
            
<li >
    <a href="../../release-notes/2016.10-release-notes/">2016.10 Release Notes</a>
</li>
            
<li >
    <a href="../../release-notes/2016.04-release-notes/">2016.04 Release Notes</a>
</li>
            
<li >
    <a href="../../release-notes/2015.10-release-notes/">2015.10 Release Notes</a>
</li>
            
<li >
    <a href="../../release-notes/2015.03-release-notes/">2015.03 Release Notes</a>
</li>
    </ul>
  </li>
                                </ul>
                            </li>
                            <li class="dropdown active">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Handbook <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../../handbook/getting-started/">Getting Started</a>
</li>
                                    
<li >
    <a href="../../handbook/common-tasks/">Common Tasks</a>
</li>
                                    
<li >
    <a href="../../handbook/systems-administration/">Systems Administration</a>
</li>
                                    
<li >
    <a href="../../handbook/network-communications/">Network Communications</a>
</li>
                                    
<li >
    <a href="../../handbook/appendix/">Appendix</a>
</li>
                                    
  <li class="dropdown-submenu">
    <a href="#">Community Contributed Tutorials</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../handbook/community/">About Community Contributed Tutorials</a>
</li>
            
<li >
    <a href="../../handbook/community/oracledb/">Oracle Database Installation</a>
</li>
            
<li >
    <a href="../../handbook/community/samqfs/">Storage Archive Manager Installation</a>
</li>
            
<li >
    <a href="../../handbook/sunray/">Sun Ray Installation</a>
</li>
            
<li >
    <a href="../../handbook/community/inputmethod/">Intelligent Input Bus (IBus)</a>
</li>
            
<li >
    <a href="../../handbook/community/squeak/">Squeak Smalltalk-80 Installation</a>
</li>
            
<li >
    <a href="../../handbook/community/texlive/">TeX Live Typesetting Software Installation</a>
</li>
            
<li >
    <a href="../../handbook/community/vagrant/">Vagrant Installation</a>
</li>
            
<li >
    <a href="../../handbook/community/quikstor/">Using RDX Quikstor media</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#">Community Hardware Compatibility List</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../community-hcl/getting-hardware-info/">Getting information about hardware</a>
</li>
            
<li >
    <a href="../../community-hcl/components/">Components</a>
</li>
            
<li >
    <a href="../../community-hcl/systems/">Systems</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#">Developer's Corner</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../building-openindiana/">Building OpenIndiana</a>
</li>
            
<li >
    <a href="../userland/">Building with oi-userland</a>
</li>
            
<li >
    <a href="../legacy-consolidations/">Building legacy consolidations</a>
</li>
            
<li >
    <a href="../graphics-stack/">Graphics stack</a>
</li>
            
<li >
    <a href="../pdf/ips-dev-guide.pdf">Packaging and Delivering Software with IPS</a>
</li>
            
<li >
    <a href="../distribution-constructor/">Using distribution constructor</a>
</li>
            
<li >
    <a href="../existing-tasks/">Existing tasks</a>
</li>
            
<li class="active">
    <a href="./">Cleaning up OpenIndiana repository</a>
</li>
    </ul>
  </li>
                                    
<li >
    <a href="../../handbook/pdfdocs/">PDF Documentation</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">OpenSolaris Books <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../../books/about/">About OpenSolaris Books</a>
</li>
                                    
<li >
    <a href="../../books/basic/">Basic Administration</a>
</li>
                                    
<li >
    <a href="../../books/advanced/">Advanced Administration</a>
</li>
                                    
<li >
    <a href="../../books/express/">Solaris Express Administration</a>
</li>
                                    
<li >
    <a href="../../books/trusted/">Trusted Extensions Administration</a>
</li>
                                    
<li >
    <a href="../../books/develop/">Development Titles</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Contrib <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../../contrib/content/">Content Creation</a>
</li>
                                    
<li >
    <a href="../../contrib/getting-started/">Getting Started</a>
</li>
                                    
<li >
    <a href="../../contrib/tools/">Contributor Tools</a>
</li>
                                    
<li >
    <a href="../../contrib/roles/">Contributor Roles</a>
</li>
                                    
<li >
    <a href="../../contrib/topics/">Contributor Topics</a>
</li>
                                    
<li >
    <a href="../../contrib/style/">Contributor Style Guide</a>
</li>
                                    
<li >
    <a href="../../contrib/markdown/">Markdown Syntax Guide</a>
</li>
                                    
<li >
    <a href="../../contrib/git/">Git Usage Guide</a>
</li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav navbar-right">
                        <li>
                            <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li >
                                <a rel="next" href="../existing-tasks/">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li >
                                <a rel="prev" href="../../handbook/pdfdocs/">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                            <li>
                                <a href="https://github.com/OpenIndiana/oi-docs/edit/master/docs/dev/repo-cleanup.md"><i class="fa fa-github"></i> Edit on GitHub</a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
        <li class="main active"><a href="#cleaning-up-openindiana-repository">Cleaning up OpenIndiana repository</a></li>
            <li><a href="#tasks-held-on-the-build-server">Tasks held on the build server</a></li>
            <li><a href="#tasks-held-on-the-package-server">Tasks held on the package server</a></li>
            <li><a href="#final-steps-and-testing">Final steps and testing</a></li>
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<!--

The contents of this Documentation are subject to the Public Documentation License Version 1.01
(the "License"); you may only use this Documentation if you comply with the terms of this License.
A copy of the License is available at http://illumos.org/license/PDL.

The Original Documentation is _________________.

The Initial Writer of the Original Documentation is Alexander Pyhalov Copyright (C) 2020
All Rights Reserved.

-->

<p><img src = "../../Openindiana.png"></p>
<h1 id="cleaning-up-openindiana-repository">Cleaning up OpenIndiana repository</h1>
<p><i class="fa fa-info-circle fa-lg" aria-hidden="true"></i> <strong>NOTE:</strong>
<div class="well">
This is an internal document provided mostly for OpenIndiana maintainers
</div></p>
<p>Due to current CI practices, OpenIndiana Hipster repository tend to bloat with old package versions.
This causes several issues:</p>
<ul>
<li><code>pkg(1)</code> starts consuming a lot of memory during planning stage;</li>
<li>refreshing repository index becomes the longest step in Jenkins build jobs;</li>
<li>storage space is wasted on pkg and build servers.</li>
</ul>
<p>To fix these issues currently periodic manual cleanup is necessary.
Note that during cleanup we preserve only latest versions of packages.
Given that it's usually just 10-20% of all published packages, using <code>pkgrepo  remove</code> is impractical.</p>
<p>The cleanup should be done on two sides: on the side of pkg server (pkg.openindiana.org) and on build server (hipster.openindiana.org) to avoid resyncing old package versions from build server to the pkg depot server.</p>
<p>Be sure to disable Jenkins jobs prior to the operation.</p>
<p>As transfering packages takes significant time (about an hour on build server and several hours on pkg server), you likely want to perform operations on both of them simultaneously.</p>
<h2 id="tasks-held-on-the-build-server">Tasks held on the build server</h2>
<p>We should cleanup packages produced by illumos-gate and oi-userland Jenkins jobs.</p>
<p>We generally don't care about packages, produced by illumos-gate build job.
They can be simply removed.
Remove them from build area:</p>
<pre><code class="bash">cd /jenkins/jobs/illumos-gate/workspace/components/openindiana/illumos-gate/
rm -fr build/i386/pkgre*
rm -fr illumos-gate/packages/i386/nightly*
</code></pre>

<p>and repository:</p>
<pre><code class="bash">cd /jenkins/jobs/illumos-gate/workspace/i386/repo/
rm -fr publisher/openindiana.org/*
</code></pre>

<p>Packages, produced by oi-userland build job, are used to generate userland-incorporation, so we can't just drop them.
We create new repository and populate it with latest packages.
This step takes some time, so be sure to run it in screen or tmux environment.</p>
<pre><code class="bash">cd /jenkins/jobs/oi-userland/workspace/i386/repo/
mkdir repo.new
cp repo/pkg5.repository repo.new/
pkgrecv -s repo --newest | tee pkg-list
cat pkg-list | split -l 100
for i in $(ls x*); do pkgrecv -s repo -d repo.new $(cat $i); done
</code></pre>

<p>Check that resulting repo contains all packages from old repository (diff should be empty).</p>
<pre><code class="bash">pkgrecv -s repo --newest &gt; /tmp/old.packages
pkgrecv -s repo.new --newest &gt; /tmp/new.packages
diff -u /tmp/old.packages /tmp/new.packages
</code></pre>

<p>If diff is not empty, investigate the issue and use <code>pkgrecv</code> to transfer missing packages individually.</p>
<p>When everything is fine, perform final cleanup.</p>
<pre><code class="bash">pkgrepo -s repo.new rebuild
rm x* pkg-list
</code></pre>

<p>Now you are ready to replace old repository with the new one.</p>
<pre><code class="bash">rm -fr repo
mv repo.new repo
</code></pre>

<h2 id="tasks-held-on-the-package-server">Tasks held on the package server</h2>
<p>The procedure is essentially the same, we create new repository and transfer latest packages and custom scripts from the old repository to the new one.
Scripts mentioned here are partially used by rsync jobs to update repository and partially can be used by pkg server administrator to perform repository maintenance.</p>
<p>You should start by creating new filesystem for the repository.
File systems on the pkg server has UUID in its name, it's replaced by literal <code>UUID</code> here.</p>
<pre><code class="bash">zfs create zones/UUID/data/repos/pkg.openindiana.org/hipster-new
</code></pre>

<p>Copy necessary scripts and files from old repository:</p>
<pre><code class="bash">cp -r /data/repos/pkg.openindiana.org/hipster/{pkg5.repository,scripts,add-content.sh} /data/repos/pkg.openindiana.org/hipster-new/
</code></pre>

<p>Make necessary directories:</p>
<pre><code class="bash">cd /data/repos/pkg.openindiana.org/hipster-new
mkdir .empty .temp .temp/.openindiana.org
</code></pre>

<p>Transfer data from current repository (the script essentially does the same batched pkgrecv as we've done on the build server):</p>
<pre><code class="bash">bash scripts/create-new-repo.sh
</code></pre>

<p>Check that resulting repo contains all packages from old repository (diff should be empty).</p>
<pre><code class="bash">pkgrecv -s /data/repos/pkg.openindiana.org/hipster-new/ --newest &gt; /tmp/new.packages
pkgrecv -s /data/repos/pkg.openindiana.org/hipster/ --newest &gt; /tmp/old.packages
diff -u /tmp/old.packages /tmp/new.packages
</code></pre>

<p>If diff is not empty, investigate the issue and use <code>pkgrecv</code> to transfer missing packages individually.</p>
<p>When everything is fine, perform final cleanup.</p>
<pre><code class="bash">pkgrepo -s . rebuild
rm x* pkg-list
</code></pre>

<p>Make pkg server actually use new repository.
Ensure that you minimise time between disabling pkg server and enabling it again - during this interval it's evidently unusable to the clients.</p>
<pre><code class="bash">cd /
svcadm disable svc:/application/pkg/server:hipster
zfs rename zones/UUID/data/repos/pkg.openindiana.org/hipster zones/UUID/data/repos/pkg.openindiana.org/hipster-old
zfs rename zones/UUID/data/repos/pkg.openindiana.org/hipster-new zones/UUID/data/repos/pkg.openindiana.org/hipster
svcadm enable svc:/application/pkg/server:hipster
</code></pre>

<h2 id="final-steps-and-testing">Final steps and testing</h2>
<p>Don't forget to enable Jenkins jobs, which you've disabled before cleanup.</p>
<ul>
<li>Visit <a href="http://pkg.openindiana.org/hipster/">http://pkg.openindiana.org/hipster/</a> and check that search works correctly.</li>
<li>Run some Jenkins build job to ensure that interaction between hipster.openindiana.org and pkg.openindiana.org works correctly.</li>
<li>Don't forget to destroy <code>zones/UUID/data/repos/pkg.openindiana.org/hipster-old</code> filesystem in several days after cleanup.</li>
</ul></div>
        </div>

        <footer class="col-md-12">
            <hr>
                <p>Copyright &copy; 2021 <a href="https://www.openindiana.org">The OpenIndiana Project</a></p>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js" defer></script>
        <script src="../../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Search</h4>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form role="form">
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="Keyboard Shortcuts Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Keyboard Shortcuts</h4>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
